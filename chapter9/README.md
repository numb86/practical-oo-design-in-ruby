# 第9章　費用対効果の高いテストを設計する

変更可能なコードを書くためには、オブジェクト指向設計についての理解だけでなく、リファクタリングとテストのスキルも不可欠。  
コードが変更可能な構成に設計されていても、実際に変更していくことが出来なければ意味がない。つまり、リファクタリングによってコードを書き換えることが出来てこそ、「変更に強い設計」は意味を持つ。  
そしてリファクタリングを支えるのが、適切に書かれたテスト。

## 9.1 意図を持ったテスト

テストを書くことの目的は、コストの削減。  
テストによって開発効率を上げることで、開発にかかる様々なコストを削減する。  
テストを書くことで得られる価値が、テストを書くコストを下回っているのでは、意味がない。  
効率のよいテストを書けないビギナーは、テストから得られる価値はコストに見合わないと感じ、テストに対して否定的になってしまう。

費用対効果の高いテストを書くためには、テストの意図を明確にすると同時に、何を、いつ、どのようにテストするのかも、理解しておく必要がある。  
そうすることで、テストから得られる価値が、テストを書くコストを上回るようになる。

### テストの意図

何のためにテストを書くのか。

バグの早期発見のため。  
バグの発見と修正は、初期段階であるほど容易である。バグの初期段階での修正は、コスト削減になる。  
バグを修正する過程で、これから実装を進めていく設計に対して理解が深まることもある。

テストはそれ自体が仕様書の役割を果たす。

テストによってリファクタリングが可能になり、それにより設計を意図的に後回しに出来る。  
必要な情報が欠けている状況では、安易に設計せず、暫定的な対応に留めるべき。その際に適切なテストを書いておけば、必要な情報が揃った段階でのリファクタリングを安全に行うことが出来る。

テストはアプリケーションの抽象化を支える。  
よい設計をすると自然と、コード全体の抽象度は上がっていく。そうなると、コードの全体像を理解することは難しくなる。  
そのような状態でも安全にコードに変更を加えるためには、テストが不可欠。

テストを書く行為によって、設計の欠陥を明らかに出来る。  
テストを書くのが難しい場合、コードに問題があるかもしれない。特定のコンテキストでないと使えない、密結合で依存関係を持ち過ぎている、など。  
テストを書くことが、こういった問題に気付くキッカケになり得る。

### 何をテストするのか

少ないコストでテストの恩恵を受けるには、必要なテストのみを書くようにする。

オブジェクト指向設計では、オブジェクト同士の依存は最低限にするのが原則。パブリックインターフェースにのみ依存し、内部の実装には関与しないようにする。そうすることで疎結合になり、変更に強くなる。  
同じことはテストにも言える。  
テストはメッセージにのみ集中し、オブジェクトの内部の実装には関与しない。  
具体的には、オブジェクトが受け付けるメッセージの戻り値と、オブジェクトが送信するメッセージのなかで副作用のあるもの（コマンドメッセージ）に対して、テストを書く。  
そうすれば、オブジェクトのプライベートな振る舞いをいくら変更してもテストは壊れず、少ないコストで大きなメリットを得られるようになる。

### いつテストするのか

テストを最初に書く「テストファースト」が望ましい。  
特に初心者は、そこから大きな恩恵を受けることが出来る。  
初心者は過度に結合されたアプリケーションを書いてしまう。依存で溢れており、変更に弱い。  
テストを最初に書くことで、それを幾分か緩和できる。テストとは再利用のことであるから、最初にテストを書いてしまうことで、コードに再利用性を持たせることを強制できる効果を得られる。

### どのようにテストするのか

テストを書くときは、テスト対象オブジェクトについての知識以外は持たないようにする。  
テスト対象オブジェクトにのみフォーカスをあてる。

テスト対象オブジェクトの内部にアクセスすることは、結合を強めることを意味する。内部の知識が外に漏れてしまっている。こうなっていると、コードの変更がテストの変更にも波及してしまう可能性が高まってしまう。  
テスト対象オブジェクトの入出力のみを捉えるようにする。
